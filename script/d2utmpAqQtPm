#!/bin/bash
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive

# âœ… Attente de la libÃ©ration du gestionnaire de paquets
echo "â³ Attente de la libÃ©ration du gestionnaire de paquets..."
while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
  echo "âš™ï¸ Un autre processus utilise apt (probablement unattended-upgrades)..."
  sleep 5
done
sudo dpkg --configure -a

sleep 30
echo "ğŸ• Attente de stabilisation du systÃ¨me avant installation..."


echo "ğŸ§° PrÃ©paration du systÃ¨me..."
sudo apt-get update -y
sudo apt-get install -yq curl git vim net-tools apt-transport-https ca-certificates gnupg lsb-release jq dos2unix unzip screen

# --- Normalisation CRLF ---
find /vagrant/script -type f -name "*.sh" -exec dos2unix {} \; || true
set -x

# --- Docker ---
echo "ğŸ³ Installation de Docker..."
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh
sudo usermod -aG docker vagrant
sudo systemctl enable docker
sudo systemctl start docker

# --- kubectl ---
echo "âš™ï¸ Installation de kubectl..."
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

# --- K3d ---
echo "ğŸš€ Installation de K3d..."
curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

# --- CrÃ©ation du cluster ---
echo "ğŸŒ CrÃ©ation du cluster K3d..."
k3d cluster delete argocd-cluster || true
k3d cluster create argocd-cluster \
  --api-port 6550 \
  -p "9090:32080@loadbalancer" \
  -p "30088:30088@loadbalancer" \
  --agents 1

# --- kubeconfig ---
mkdir -p /home/vagrant/.kube
k3d kubeconfig get argocd-cluster > /home/vagrant/.kube/config
export KUBECONFIG=/home/vagrant/.kube/config
sudo chown -R vagrant:vagrant /home/vagrant/.kube
echo 'export KUBECONFIG=/home/vagrant/.kube/config' >> /home/vagrant/.bashrc

# --- ArgoCD ---
echo "ğŸ§© Installation de ArgoCD..."
kubectl create namespace argocd || true
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

echo "â³ Attente du dÃ©ploiement d'ArgoCD..."
kubectl wait --for=condition=available --timeout=600s deployment/argocd-server -n argocd || true

# --- Patch du service ---
echo "ğŸ› ï¸ Configuration du service ArgoCD..."
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "NodePort","ports":[{"port":80,"nodePort":32080},{"port":443,"nodePort":32514}]}}'

# --- Mot de passe ArgoCD ---
ARGO_PASS=$(kubectl get secret -n argocd argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 --decode)
echo "ğŸ”‘ Mot de passe admin ArgoCD: $ARGO_PASS"

# --- Ajout automatique du repo GitHub ---
echo "ğŸ”— Ajout du repository GitHub Ã  ArgoCD..."
kubectl apply -n argocd -f - <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: vitocodepython-argocd-infra
  namespace: argocd
  labels:
    argocd.argoproj.io/secret-type: repository
stringData:
  url: https://github.com/vitocodepython/argocd-infra.git
  type: git
EOF

# --- DÃ©ploiement automatique de vito-app via app.yaml ---
echo "ğŸš€ DÃ©ploiement automatique de vito-app depuis app.yaml..."
until kubectl get crd applications.argoproj.io &>/dev/null; do
  echo "â³ En attente que les CRDs ArgoCD soient prÃªts..."
  sleep 5
done
kubectl apply -n argocd -f /vagrant/manifests/app.yaml

sleep 30

# ======================
# ğŸŒ NGROK SECTION v3.0
# ======================
echo "ğŸŒ Installation de Ngrok (v3)..."
sudo rm -f /usr/local/bin/ngrok
curl -sL https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz -o ngrok.tgz
tar -xvzf ngrok.tgz
sudo mv ngrok /usr/local/bin/
rm ngrok.tgz

# --- Configuration du token ---
mkdir -p /home/vagrant/.config/ngrok
if [[ -n "${NGROK_AUTHTOKEN:-}" ]]; then
  echo "ğŸ” Ajout du token Ngrok..."
  echo "authtoken: $NGROK_AUTHTOKEN" > /home/vagrant/.config/ngrok/ngrok.yml
else
  echo "âš ï¸ Aucun NGROK_AUTHTOKEN trouvÃ©, ngrok fonctionnera en mode limitÃ©."
fi
sudo chown -R vagrant:vagrant /home/vagrant/.config/ngrok

# --- Lancement du tunnel ---
echo "ğŸš¦ Lancement du tunnel Ngrok sur le port 9090..."
screen -dmS ngrok ngrok http http://0.0.0.0:9090 --log=stdout > /tmp/ngrok.log 2>&1
sleep 15

NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[]?.public_url' | grep https || true)
if [[ -z "$NGROK_URL" ]]; then
  echo "âŒ Ngrok ne semble pas dÃ©marrÃ© (API 4040 inaccessible)."
  NGROK_URL="non_disponible"
else
  echo "ğŸŒ Tunnel Ngrok actif : $NGROK_URL"
fi

# --- CrÃ©ation automatique du webhook GitHub ---
echo "ğŸ”— Configuration automatique du webhook GitHub..."
bash /vagrant/script/github_webhook.sh || echo "âš ï¸ Ã‰chec de la configuration du webhook"


# --- VÃ©rification de vito-app ---
if kubectl get applications.argoproj.io vito-app -n argocd &>/dev/null; then
  echo "âœ… ArgoCD application vito-app est bien crÃ©Ã©e et synchronisÃ©e."
else
  echo "âŒ vito-app nâ€™a pas pu Ãªtre dÃ©tectÃ©e dans ArgoCD."
fi

# --- RÃ©cupÃ©ration de l'URL de vito-app ---
APP_NODEPORT=$(kubectl get svc vito-app -n default -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "30088")
APP_URL="http://localhost:${APP_NODEPORT}"

# --- RÃ©sumÃ© final ---
echo "------------------------------------------"
echo "ğŸ‰ [INSTALLATION TERMINÃ‰E AVEC SUCCÃˆS]"
echo "ğŸŒ ArgoCD : http://localhost:9090"
echo "ğŸ‘¤ Identifiant : admin"
echo "ğŸ”‘ Mot de passe : $ARGO_PASS"
echo "ğŸŒ Application vito-app : $APP_URL"
echo "ğŸ”— Tunnel public : $NGROK_URL"
echo "------------------------------------------"
